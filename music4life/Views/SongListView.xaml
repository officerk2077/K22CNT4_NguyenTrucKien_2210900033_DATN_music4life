<UserControl x:Class="music4life.Views.SongListView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800"
             Background="#121212">

    <UserControl.Resources>
        <ControlTemplate x:Key="HamburgerComboBoxTemplate" TargetType="ComboBox">
            <Grid>
                <ToggleButton Name="ToggleButton" BorderThickness="0" Background="Transparent" Focusable="false" IsChecked="{Binding Path=IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}" ClickMode="Press">
                    <ToggleButton.Template>
                        <ControlTemplate TargetType="ToggleButton">
                            <Border Name="Border" Background="Transparent" CornerRadius="4" Padding="5">
                                <Path Name="Icon" Data="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" Fill="#B3B3B3" Stretch="Uniform" Width="16" Height="16"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="true">
                                    <Setter TargetName="Border" Property="Background" Value="#333"/>
                                    <Setter TargetName="Icon" Property="Fill" Value="White"/>
                                </Trigger>
                                <Trigger Property="IsChecked" Value="true">
                                    <Setter TargetName="Border" Property="Background" Value="#222"/>
                                    <Setter TargetName="Icon" Property="Fill" Value="#00ADEF"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </ToggleButton.Template>
                </ToggleButton>
                <Popup Name="Popup" Placement="Bottom" IsOpen="{TemplateBinding IsDropDownOpen}" AllowsTransparency="True" Focusable="False" PopupAnimation="Slide">
                    <Grid Name="DropDown" SnapsToDevicePixels="True" MinWidth="{TemplateBinding ActualWidth}" MaxHeight="{TemplateBinding MaxDropDownHeight}">
                        <Border x:Name="DropDownBorder" Background="#2B2B2B" BorderThickness="1" BorderBrush="#444" CornerRadius="4" Margin="0,2,0,0">
                            <ScrollViewer Margin="2" SnapsToDevicePixels="True">
                                <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Contained" />
                            </ScrollViewer>
                        </Border>
                    </Grid>
                </Popup>
            </Grid>
        </ControlTemplate>

        <Style x:Key="HamburgerComboBoxItemStyle" TargetType="ComboBoxItem">
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="#E0E0E0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBoxItem">
                        <Border x:Name="bd" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                            <ContentPresenter />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="#444444"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="bd" Property="Background" Value="#00ADEF"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="{x:Type ScrollBar}">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Width" Value="8"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ScrollBar}">
                        <Grid x:Name="Bg" SnapsToDevicePixels="true">
                            <Track x:Name="PART_Track" IsDirectionReversed="true">
                                <Track.Thumb>
                                    <Thumb>
                                        <Thumb.Template>
                                            <ControlTemplate TargetType="{x:Type Thumb}">
                                                <Border Background="#444444" CornerRadius="4"/>
                                            </ControlTemplate>
                                        </Thumb.Template>
                                    </Thumb>
                                </Track.Thumb>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DarkMenuItemStyle" TargetType="{x:Type MenuItem}">
            <Setter Property="SnapsToDevicePixels" Value="True" />
            <Setter Property="OverridesDefaultStyle" Value="True" />
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="#E0E0E0"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type MenuItem}">
                        <Border x:Name="Border" Background="{TemplateBinding Background}" BorderThickness="0" Padding="10,8">
                            <ContentPresenter ContentSource="Header"
                                              RecognizesAccessKey="True" 
                                              HorizontalAlignment="Left"
                                              VerticalAlignment="Center"
                                              SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#00ADEF"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="#666"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DarkMenuItemWithSubmenuStyle" TargetType="{x:Type MenuItem}" BasedOn="{StaticResource DarkMenuItemStyle}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type MenuItem}">
                        <Border x:Name="Border" Background="{TemplateBinding Background}" BorderThickness="0" Padding="10,8">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <ContentPresenter ContentSource="Header" RecognizesAccessKey="True" VerticalAlignment="Center" HorizontalAlignment="Left"/>

                                <Path Grid.Column="1" Data="M0,0 L4,4 L0,8" Stroke="{TemplateBinding Foreground}" StrokeThickness="1" Margin="10,0,0,0" VerticalAlignment="Center" Opacity="0.7"/>

                                <Popup x:Name="Popup" Placement="Right" IsOpen="{TemplateBinding IsSubmenuOpen}" AllowsTransparency="True" Focusable="False" PopupAnimation="Fade">
                                    <Border x:Name="SubmenuBorder" 
                                            Grid.IsSharedSizeScope="True"
                                            Background="#2B2B2B" 
                                            BorderThickness="1" 
                                            BorderBrush="#444" 
                                            CornerRadius="4" 
                                            Margin="2,0,0,0">
                                        <Border.Effect>
                                            <DropShadowEffect BlurRadius="10" ShadowDepth="3" Opacity="0.5" Color="Black"/>
                                        </Border.Effect>
                                        <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle"/>
                                    </Border>
                                </Popup>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#00ADEF"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DarkContextMenuStyle" TargetType="{x:Type ContextMenu}">
            <Setter Property="SnapsToDevicePixels" Value="True" />
            <Setter Property="OverridesDefaultStyle" Value="True" />
            <Setter Property="Grid.IsSharedSizeScope" Value="true" />
            <Setter Property="HasDropShadow" Value="True" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ContextMenu}">
                        <Border x:Name="Border" Background="#2B2B2B" BorderThickness="1" BorderBrush="#444444" CornerRadius="6" Padding="0,4">
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="10" ShadowDepth="3" Opacity="0.4" Color="Black"/>
                            </Border.Effect>
                            <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="{x:Type Separator}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Separator}">
                        <Border Background="#444444" Height="1" Margin="10,4,10,4" SnapsToDevicePixels="true"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" BorderBrush="#333" BorderThickness="0,0,0,1" Margin="0,0,0,5" Padding="10,10,25,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="50"/>
                    <ColumnDefinition Width="2.5*" MinWidth="150"/>
                    <ColumnDefinition Width="1.5*" MinWidth="100"/>
                    <ColumnDefinition Width="1.5*" MinWidth="100"/>
                    <ColumnDefinition Width="1.2*" MinWidth="80"/>
                    <ColumnDefinition Width="60"/>
                    <ColumnDefinition Width="60"/>
                </Grid.ColumnDefinitions>

                <ComboBox Grid.Column="0" HorizontalAlignment="Left" Template="{StaticResource HamburgerComboBoxTemplate}" ItemContainerStyle="{StaticResource HamburgerComboBoxItemStyle}" SelectedIndex="-1">
                    <ComboBoxItem Content="Tên (A-Z)" Tag="Title_AZ" Selected="SortOption_Selected"/>
                    <ComboBoxItem Content="Tên (Z-A)" Tag="Title_ZA" Selected="SortOption_Selected"/>
                    <Separator Background="#444"/>
                    <ComboBoxItem Content="Nghệ sĩ" Tag="Artist" Selected="SortOption_Selected"/>
                    <ComboBoxItem Content="Album" Tag="Album" Selected="SortOption_Selected"/>
                    <Separator Background="#444"/>
                    <ComboBoxItem Content="Thời lượng (Tăng)" Tag="Duration_Short" Selected="SortOption_Selected"/>
                    <ComboBoxItem Content="Thời lượng (Giảm)" Tag="Duration_Long" Selected="SortOption_Selected"/>
                    <Separator Background="#444"/>
                    <ComboBoxItem Content="Mới thêm vào" Tag="DateAdded" Selected="SortOption_Selected"/>
                </ComboBox>

                <TextBlock Grid.Column="1" Text="Title" Margin="0,0,0,0" Foreground="#B3B3B3" FontWeight="Bold"/>
                <TextBlock Grid.Column="2" Text="Artist" Margin="10,0,0,0" Foreground="#B3B3B3" FontWeight="Bold"/>
                <TextBlock Grid.Column="3" Text="Album" Margin="20,0,0,0" Foreground="#B3B3B3" FontWeight="Bold"/>
                <TextBlock Grid.Column="4" Text="Genre" Margin="25,0,0,0" Foreground="#B3B3B3" FontWeight="Bold"/>
                <TextBlock Grid.Column="5" Text="Year" Margin="35,0,-10,0" Foreground="#B3B3B3" FontWeight="Bold" HorizontalAlignment="Center"/>
                <TextBlock Grid.Column="6" Text="Time" Margin="30,0,-10,0" Foreground="#B3B3B3" FontWeight="Bold" HorizontalAlignment="Right" />
            </Grid>
        </Border>

        <ListView x:Name="MusicListView" Grid.Row="1"
                  SelectedItem="{Binding SelectedSong}"
                  Background="Transparent" 
                  BorderThickness="0" 
                  ItemsSource="{Binding DisplayedTracks}"
                  ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                  ScrollViewer.VerticalScrollBarVisibility="Auto" 
                  HorizontalContentAlignment="Stretch">

            <ListView.ItemTemplate>
                <DataTemplate>
                    <Grid Margin="0,5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="50"/>
                            <ColumnDefinition Width="2.5*" MinWidth="150"/>
                            <ColumnDefinition Width="1.5*" MinWidth="100"/>
                            <ColumnDefinition Width="1.5*" MinWidth="100"/>
                            <ColumnDefinition Width="1.2*" MinWidth="80"/>
                            <ColumnDefinition Width="60"/>
                            <ColumnDefinition Width="60"/>
                        </Grid.ColumnDefinitions>

                        <Grid Grid.Column="0" HorizontalAlignment="Center">
                            <Path x:Name="IconNote" Data="M12,3V12.26C11.5,12.09 11,12 10.5,12C8,12 6,14 6,16.5C6,19 8,21 10.5,21C13,21 15,19 15,16.5V6H19V3H12Z" Fill="#555" Width="12" Height="12" Stretch="Uniform"/>
                            <Path x:Name="IconPlaying" Data="M3,9H7L12,4V20L7,15H3V9M16.5,12C16.5,13.23 15.5,14.23 14.5,14.23V9.77C15.5,9.77 16.5,10.77 16.5,12Z" Fill="#00ADEF" Width="14" Height="14" Stretch="Uniform" Visibility="Collapsed"/>
                        </Grid>

                        <TextBlock x:Name="TxtTitle" Grid.Column="1" Text="{Binding Title}" Margin="10,0,10,0" Foreground="White" FontWeight="SemiBold" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" ToolTip="{Binding Title}"/>
                        <TextBlock Grid.Column="2" Text="{Binding Artist}" Margin="10,0,10,0" Foreground="#B3B3B3" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" ToolTip="{Binding Artist}"/>
                        <TextBlock Grid.Column="3" Text="{Binding Album}" Margin="10,0,10,0" Foreground="#B3B3B3" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" ToolTip="{Binding Album}"/>
                        <TextBlock Grid.Column="4" Text="{Binding Genre}" Margin="10,0,10,0" Foreground="#B3B3B3" TextTrimming="CharacterEllipsis" VerticalAlignment="Center" ToolTip="{Binding Genre}"/>
                        <TextBlock Grid.Column="5" Text="{Binding Year}" Margin="0,0,0,0" Foreground="#B3B3B3" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        <TextBlock Grid.Column="6" Text="{Binding Duration}" Margin="0,0,10,0" Foreground="#B3B3B3" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                    </Grid>
                    <DataTemplate.Triggers>
                        <DataTrigger Binding="{Binding IsPlaying}" Value="True">
                            <Setter TargetName="TxtTitle" Property="Foreground" Value="#00ADEF"/>
                            <Setter TargetName="IconNote" Property="Visibility" Value="Collapsed"/>
                            <Setter TargetName="IconPlaying" Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </DataTemplate.Triggers>
                </DataTemplate>
            </ListView.ItemTemplate>

            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>

                    <Setter Property="Tag" Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}"/>

                    <Setter Property="ContextMenu">
                        <Setter.Value>
                            <ContextMenu Style="{StaticResource DarkContextMenuStyle}">

                                <MenuItem Header="Phát ngay" Style="{StaticResource DarkMenuItemStyle}"
                                          Command="{Binding PlacementTarget.Tag.PlaySongCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                          CommandParameter="{Binding}"/>

                                <MenuItem Header="Phát kế tiếp" Style="{StaticResource DarkMenuItemStyle}"
                                          Command="{Binding PlacementTarget.Tag.PlayNextCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                          CommandParameter="{Binding}"/>

                                <Separator Background="#444"/>

                                <MenuItem Header="Thêm vào Playlist"
                                          Style="{StaticResource DarkMenuItemWithSubmenuStyle}"
                                          ItemsSource="{Binding PlacementTarget.Tag.UserPlaylists, RelativeSource={RelativeSource AncestorType=ContextMenu}}">

                                    <MenuItem.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Name}" 
                                                       VerticalAlignment="Center"
                                                       HorizontalAlignment="Left"
                                                       Foreground="#E0E0E0"  
                                                       FontSize="13"
                                                       Margin="0"/>
                                        </DataTemplate>
                                    </MenuItem.ItemTemplate>

                                    <MenuItem.ItemContainerStyle>
                                        <Style TargetType="MenuItem" BasedOn="{StaticResource DarkMenuItemStyle}">
                                            <Setter Property="Command" Value="{Binding PlacementTarget.Tag.AddSongToPlaylistCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                            <Setter Property="CommandParameter" Value="{Binding}"/>
                                            <Setter Property="Background" Value="#2B2B2B"/>
                                            <Setter Property="Foreground" Value="#E0E0E0"/>
                                        </Style>
                                    </MenuItem.ItemContainerStyle>
                                </MenuItem>

                                <MenuItem Command="{Binding PlacementTarget.Tag.ToggleFavoriteCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                          CommandParameter="{Binding}">
                                    <MenuItem.Style>
                                        <Style TargetType="MenuItem" BasedOn="{StaticResource DarkMenuItemStyle}">
                                            <Setter Property="Header" Value="Thêm vào ưa thích"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                    <Setter Property="Header" Value="Bỏ thích"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </MenuItem.Style>
                                </MenuItem>

                                <MenuItem Header="Thêm vào hàng chờ" Style="{StaticResource DarkMenuItemStyle}"
                                          Command="{Binding PlacementTarget.Tag.AddToQueueCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                          CommandParameter="{Binding}"/>

                                <MenuItem Header="Xóa khỏi danh sách" Style="{StaticResource DarkMenuItemStyle}"
                                          Command="{Binding PlacementTarget.Tag.RemoveSongCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                          CommandParameter="{Binding}"/>

                            </ContextMenu>
                        </Setter.Value>
                    </Setter>

                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListViewItem">
                                <Border x:Name="Bd" Background="{TemplateBinding Background}" CornerRadius="5" Padding="0,8" Margin="0,2">
                                    <ContentPresenter/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="Bd" Property="Background" Value="#2A2A2A"/>
                                    </Trigger>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter TargetName="Bd" Property="Background" Value="#333333"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                    <EventSetter Event="MouseDoubleClick" Handler="SongItem_MouseDoubleClick"/>

                    <EventSetter Event="PreviewMouseRightButtonDown" Handler="ListViewItem_PreviewMouseRightButtonDown"/>
                </Style>
            </ListView.ItemContainerStyle>
        </ListView>

        <Border Grid.Row="2" Padding="0,10,0,15" HorizontalAlignment="Center">
            <TextBlock Foreground="#666666" FontSize="13" FontStyle="Italic">
                 <Run Text="{Binding DisplayedTracks.Count, Mode=OneWay, FallbackValue=0}" />
                 <Run Text=" bài hát" />
            </TextBlock>
        </Border>

    </Grid>
</UserControl>